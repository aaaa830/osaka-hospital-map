<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>大阪市 病院検索（追加編集・削除・電話・タグ・病床・経路距離・最寄り駅）</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
header{padding:12px;border-bottom:1px solid #ddd;background:#fafafa}
.row{display:flex;gap:12px;align-items:flex-end}
label{font-size:12px;color:#555;display:block;margin-bottom:4px}
input,button,textarea{padding:10px;font-size:15px;border:1px solid #ccc;border-radius:10px}
textarea{border-radius:10px}
button{cursor:pointer;background:#fff}
button:active{transform:translateY(1px)}

#wrap{display:grid;grid-template-columns:1.2fr 1fr;height:calc(100vh - 320px)}
#map{width:100%;height:100%}
#side{overflow:auto;border-left:1px solid #ddd;background:#fff}

.panel{padding:12px;border-bottom:1px solid #eee}
.panel h3{margin:0 0 8px;font-size:16px}
.small{font-size:12px;color:#666;line-height:1.4}
.warn{color:#b00;font-weight:600}

.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{border:1px solid #ccc;border-radius:999px;padding:4px 10px;font-size:12px;display:inline-flex;align-items:center;gap:6px;background:#fff}

.card{padding:12px;border-bottom:1px solid #eee;cursor:pointer}
.card:hover{background:#f7f7f7}
.title{font-weight:700}
.meta{font-size:13px;color:#555;margin-top:4px}
.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.badge{font-size:12px;padding:3px 8px;border:1px solid #ccc;border-radius:999px;background:#fff}
.actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.actions button{padding:6px 10px;font-size:13px}

.bed-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px}
.bed-row{display:grid;grid-template-columns:90px 1fr 30px;gap:6px;align-items:center}
.bed-row span{font-size:12px;color:#555}

/* ===== スマホ最適化（機能は変えない） ===== */
@media (max-width: 900px){
  header{position:sticky;top:0;z-index:5}
  .row{flex-wrap:wrap;align-items:stretch}
  #wrap{display:flex;flex-direction:column;height:auto}
  #map{height:45vh;min-height:320px}
  #side{border-left:none;border-top:1px solid #ddd;overflow:visible}
  .panel{padding:10px}
  input,button,textarea{font-size:16px} /* iPhoneズーム回避 */
  .bed-grid{grid-template-columns:1fr}
  .bed-row{grid-template-columns:90px 1fr 30px}
}
</style>
</head>

<body>

<header>
  <div class="row">
    <div style="flex:0 1 520px;min-width:240px">
      <label>出発地</label>
      <input id="origin" style="width:100%" placeholder="例：桜川駅 / 堺市 / 大阪市浪速区">
    </div>

    <div style="display:flex;gap:12px;margin-left:auto;flex-wrap:wrap;align-items:flex-end">
      <div>
        <label>検索範囲（km）</label>
        <input id="radiusKm" inputmode="decimal" value="8" style="width:140px">
      </div>
      <div>
        <label>表示件数</label>
        <input id="limit" inputmode="numeric" value="20" style="width:110px">
      </div>

      <button id="btnSearch" type="button">検索</button>
      <button id="btnExport" type="button">JSON出力</button>
    </div>
  </div>

  <div class="small" style="margin-top:8px">検索タグ（AND）</div>
  <div id="searchTags" class="tags" style="margin-top:6px"></div>

  <div class="small" id="status" style="margin-top:6px"></div>
</header>

<div id="wrap">
  <div id="map"></div>

  <div id="side">
    <div class="panel">
      <h3>病院を追加 / 編集</h3>

      <input id="hName" style="width:100%" placeholder="病院名"><br><br>
      <input id="hAddr" style="width:100%" placeholder="住所"><br><br>
      <input id="hTel" style="width:100%" placeholder="電話番号"><br><br>

      <!-- 最寄り駅 -->
      <input id="hNearest" style="width:100%" placeholder="最寄り駅（例：扇町駅 / 桜川駅）"><br><br>

      <div class="small">タグ（病院に付ける）</div>
      <div id="formTags" class="tags" style="margin-top:6px"></div>

      <div class="small" style="margin-top:10px">病床</div>
      <div class="bed-grid">
        <div class="bed-row">急性期<input id="bed_acute" type="number" min="0"><span>床</span></div>
        <div class="bed-row">一般<input id="bed_general" type="number" min="0"><span>床</span></div>
        <div class="bed-row">回復期<input id="bed_rehab" type="number" min="0"><span>床</span></div>
        <div class="bed-row">療養<input id="bed_long" type="number" min="0"><span>床</span></div>
        <div class="bed-row">地域包括<input id="bed_chiiki" type="number" min="0"><span>床</span></div>
        <div class="bed-row">精神<input id="bed_psy" type="number" min="0"><span>床</span></div>
        <div class="bed-row">緩和ケア<input id="bed_palliative" type="number" min="0"><span>床</span></div>
        <div class="bed-row">障害<input id="bed_disability" type="number" min="0"><span>床</span></div>
      </div>

      <textarea id="hNote" style="width:100%;margin-top:8px" placeholder="メモ（検索結果とピンに表示）"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="btnSave" type="button">追加 / 更新</button>
        <button id="btnReset" type="button">クリア</button>
      </div>

      <div class="small" id="editHint" style="margin-top:6px"></div>
    </div>

    <div class="panel">
      <h3>検索結果（経路距離が近い順）</h3>
      <div id="list"></div>
    </div>
  </div>
</div>

<script>
/* ====== 設定 ====== */
const DB_KEY="osaka_hospital_db_tagsplit_v2_tel_bedgrid";
const TAGS=["急性期","一般","回復期","療養","地域包括","緩和ケア","精神","障害","透析","ST在籍"];

/* ====== 状態 ====== */
let hospitals = loadHospitals();
let map, geocoder, directions, infoWindow;
let markers = [];
let editId = null;
let searchToken = 0; // 検索の中断用

const $ = (id) => document.getElementById(id);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

const escapeHtml = (s) => (s || "").replace(/[&<>"']/g, c => (
  {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]
));
const kmText = (m) => (typeof m === "number") ? (m/1000).toFixed(1) + " km" : "取得不可";
const telHref = (t) => t ? `tel:${t.replace(/[^0-9+]/g,"")}` : "";

/* ====== UI ====== */
function setStatus(t, w=false){
  $("status").innerHTML = w ? `<span class="warn">${escapeHtml(t)}</span>` : escapeHtml(t);
}

function renderTagBox(containerId, selected=[]){
  const box = $(containerId);
  box.innerHTML = "";
  const sel = new Set(selected || []);
  TAGS.forEach(t=>{
    const l = document.createElement("label");
    l.className = "tag";
    l.innerHTML = `<input type="checkbox" value="${escapeHtml(t)}" ${sel.has(t)?"checked":""}> ${escapeHtml(t)}`;
    box.appendChild(l);
  });
}
function getTags(containerId){
  return [...document.querySelectorAll(`#${containerId} input:checked`)].map(x=>x.value);
}

function readBedsFromForm(){
  return {
    acute: +$("bed_acute").value || 0,
    general: +$("bed_general").value || 0,
    rehab: +$("bed_rehab").value || 0,
    long: +$("bed_long").value || 0,
    chiiki: +$("bed_chiiki").value || 0,
    psy: +$("bed_psy").value || 0,
    palliative: +$("bed_palliative").value || 0,
    disability: +$("bed_disability").value || 0
  };
}
function bedText(beds){
  const m = {acute:"急性期",general:"一般",rehab:"回復期",long:"療養",chiiki:"地域包括",psy:"精神",palliative:"緩和",disability:"障害"};
  return Object.entries(beds||{})
    .filter(([k,v]) => Number(v) > 0)
    .map(([k,v]) => `${m[k]}${v}床`)
    .join(" / ");
}

/* ====== localStorage ====== */
function loadHospitals(){
  try {
    const arr = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
    return (Array.isArray(arr) ? arr : []).map(h => ({
      ...h,
      tags: Array.isArray(h.tags) ? h.tags : [],
      beds: (h.beds && typeof h.beds === "object") ? h.beds : {
        acute:0,general:0,rehab:0,long:0,chiiki:0,psy:0,palliative:0,disability:0
      },
      note: h.note || "",
      nearest: h.nearest || ""
    }));
  } catch {
    return [];
  }
}
function saveHospitals(){
  localStorage.setItem(DB_KEY, JSON.stringify(hospitals));
}

/* ===== JSON出力（バックアップ用） ===== */
function exportHospitalsJSON(){
  const json = JSON.stringify(hospitals, null, 2);
  const blob = new Blob([json], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "hospitals_backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

/* ====== map helpers ====== */
function clearMarkers(){
  markers.forEach(m=>m.setMap(null));
  markers = [];
  if (infoWindow) infoWindow.close();
}

function normalizeNumberInput(v, fallback){
  const s = (v ?? "").toString().replace(/[^\d.]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? n : fallback;
}
function normalizeIntInput(v, fallback){
  const s = (v ?? "").toString().replace(/[^\d]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? Math.trunc(n) : fallback;
}

function geocode(addr){
  return new Promise((ok, ng)=>{
    geocoder.geocode({address: addr, region: "JP"}, (r, s)=>{
      if (s === "OK" && r && r[0]) ok(r[0].geometry.location);
      else ng(new Error("出発地/住所が見つかりません（表記を少し変えて）"));
    });
  });
}

/* 経路距離（成功時だけ meters を返す） */
function routeMeters(origin, h){
  return new Promise(res=>{
    directions.route({
      origin,
      destination: {lat: h.lat, lng: h.lng},
      travelMode: google.maps.TravelMode.DRIVING
    }, (r, s)=>{
      if (s === "OK" && r.routes?.[0]?.legs?.[0]) {
        res({ meters: r.routes[0].legs[0].distance.value, status: s });
      } else {
        res({ meters: null, status: s });
      }
    });
  });
}

/* ===== 編集フォーム ===== */
function fillForm(h){
  editId = h.id;
  $("hName").value = h.name || "";
  $("hAddr").value = h.address || "";
  $("hTel").value  = h.tel || "";
  $("hNearest").value = h.nearest || "";
  $("hNote").value = h.note || "";

  const b = h.beds || {};
  $("bed_acute").value = b.acute || "";
  $("bed_general").value = b.general || "";
  $("bed_rehab").value = b.rehab || "";
  $("bed_long").value = b.long || "";
  $("bed_chiiki").value = b.chiiki || "";
  $("bed_psy").value = b.psy || "";
  $("bed_palliative").value = b.palliative || "";
  $("bed_disability").value = b.disability || "";

  renderTagBox("formTags", Array.isArray(h.tags) ? h.tags : []);
  $("editHint").innerHTML = `編集モード：<b>${escapeHtml(h.name||"")}</b>`;
}

function resetForm(){
  editId = null;
  $("hName").value = "";
  $("hAddr").value = "";
  $("hTel").value  = "";
  $("hNearest").value = "";
  $("hNote").value = "";
  ["acute","general","rehab","long","chiiki","psy","palliative","disability"].forEach(k => {
    $("bed_"+k).value = "";
  });
  renderTagBox("formTags", []);
  $("editHint").textContent = "";
}

function deleteHospital(id){
  hospitals = hospitals.filter(x => x.id !== id);
  saveHospitals();
  setStatus("削除しました");
  if (editId === id) resetForm();
  runSearch();
}

async function saveHospital(){
  const name = $("hName").value.trim();
  const addr = $("hAddr").value.trim();
  if (!name || !addr) return setStatus("病院名と住所は必須", true);

  setStatus("住所を座標化中…");
  let ll;
  try { ll = await geocode(addr); }
  catch(e){ return setStatus(e.message, true); }

  const obj = {
    id: editId || ("h_" + Date.now()),
    name,
    address: addr,
    tel: $("hTel").value.trim(),
    nearest: $("hNearest").value.trim(),
    lat: ll.lat(),
    lng: ll.lng(),
    tags: getTags("formTags"),
    beds: readBedsFromForm(),
    note: $("hNote").value.trim()
  };

  hospitals = hospitals.filter(x => x.id !== obj.id);
  hospitals.push(obj);
  saveHospitals();

  setStatus("保存しました");
  resetForm();
  runSearch();
}

/* ===== 検索（経路距離のみ） ===== */
async function runSearch(){
  const myToken = ++searchToken;
  clearMarkers();

  const originTxt = $("origin").value.trim();
  if(!originTxt) return setStatus("出発地を入力してください", true);

  // 入力の耐性（スマホで空扱いになるの防ぐ）
  const radiusKm = Math.max(0.1, normalizeNumberInput($("radiusKm").value, 8));
  const limit = Math.max(1, normalizeIntInput($("limit").value, 20));

  setStatus("出発地を検索中…");
  let origin;
  try { origin = await geocode(originTxt); }
  catch(e){ return setStatus(e.message, true); }

  if (myToken !== searchToken) return; // 中断

  map.setCenter(origin);
  map.setZoom(12);
  markers.push(new google.maps.Marker({map, position: origin}));

  const need = new Set(getTags("searchTags"));

  const filtered = hospitals.filter(h => {
    const t = Array.isArray(h.tags) ? h.tags : [];
    if (need.size === 0) return true;
    return [...need].every(x => t.includes(x));
  });

  // ここが肝：258件全部にDirectionsしない。上から順にゆっくり叩いて必要数だけ集める。
  // （直線距離は使わない。経路が取れたものだけを採用）
  const radiusM = radiusKm * 1000;

  setStatus(`経路距離を計算中…（半径 ${radiusKm}km / 上限 ${limit}件）`);

  let results = [];
  let fail = 0, over = 0;

  // 叩く上限（増やしたければここだけ）
  const MAX_TRY = Math.max(limit * 12, 180); // limit20なら240件まで
  const targets = filtered.slice(0, MAX_TRY);

  for (let i = 0; i < targets.length; i++){
    if (myToken !== searchToken) return; // 中断

    const h = targets[i];
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;

    // 進捗
    if (i % 10 === 0) setStatus(`経路距離を計算中… ${i}/${targets.length}（集計 ${results.length}/${limit}）`);

    // 連打防止（スマホ/回線でも安定）
    await sleep(140);

    const r = await routeMeters(origin, h);

    if (r.status === "OVER_QUERY_LIMIT") over++;
    if (r.meters === null) { fail++; continue; }

    if (r.meters <= radiusM){
      results.push({...h, meters: r.meters});
      if (results.length >= limit) break; // 必要数集まったら終了
    }

    // OVERが多い時は少し休む（回復）
    if (over > 0 && over % 3 === 0) await sleep(600);
  }

  results.sort((a,b)=>a.meters-b.meters);
  results = results.slice(0, limit);

  const listEl = $("list");
  listEl.innerHTML = "";

  if (results.length === 0){
    listEl.innerHTML = `<div class="small">該当なし（範囲を広げる / タグを減らす）</div>`;
    return setStatus(`表示：0件（経路失敗 ${fail} / OVER_QUERY_LIMIT ${over}）`, true);
  }

  results.forEach((h, i)=>{
    const mk = new google.maps.Marker({
      map,
      position: {lat: h.lat, lng: h.lng},
      label: String(i+1)
    });
    markers.push(mk);

    mk.addListener("click", ()=>{
      const bed = bedText(h.beds) || "未記載";
      const nearestLine = h.nearest ? `最寄り駅：${escapeHtml(h.nearest)}` : "最寄り駅：未記載";
      infoWindow.setContent(`
        <div style="font-size:14px;line-height:1.35;min-width:240px;max-width:320px;">
          <div style="font-weight:700;">${escapeHtml(h.name||"")}</div>
          <div style="margin-top:4px;">${escapeHtml(h.address||"")}</div>
          ${h.tel ? `<div style="margin-top:4px;font-size:12px;">☎ <a href="${telHref(h.tel)}">${escapeHtml(h.tel)}</a></div>` : ``}
          <div style="margin-top:6px;font-size:12px;color:#555;">経路距離：${escapeHtml(kmText(h.meters))}</div>
          <div style="margin-top:4px;font-size:12px;color:#555;">病床：${escapeHtml(bed)}</div>
          <div style="margin-top:4px;font-size:12px;color:#555;">${nearestLine}</div>
          ${h.tags?.length ? `<div style="margin-top:6px;font-size:12px;">タグ：${h.tags.map(escapeHtml).join(" / ")}</div>` : ``}
          ${h.note ? `<div style="margin-top:6px;font-size:12px;color:#555;">メモ：${escapeHtml(h.note)}</div>` : ``}
        </div>
      `);
      infoWindow.open({map, anchor: mk});
    });

    const telLine = h.tel ? `<div class="small">☎ ${escapeHtml(h.tel)}</div>` : "";
    const nearestLine = h.nearest ? `<div class="small">最寄り駅：${escapeHtml(h.nearest)}</div>` : `<div class="small">最寄り駅：未記載</div>`;
    const noteLine = h.note ? `<div class="small">メモ：${escapeHtml(h.note)}</div>` : "";
    const bedLine = `<div class="small">病床：${escapeHtml(bedText(h.beds) || "未記載")}</div>`;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="title">${i+1}. ${escapeHtml(h.name||"")}</div>
      <div class="meta">${escapeHtml(h.address||"")}</div>
      ${telLine}
      ${bedLine}
      ${nearestLine}
      ${noteLine}
      <div class="badges">
        <span class="badge">経路距離 ${escapeHtml(kmText(h.meters))}</span>
        ${(h.tags||[]).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join("")}
      </div>
      <div class="actions">
        <button data-edit="1" type="button">編集</button>
        <button data-del="1" type="button">削除</button>
      </div>
    `;

    div.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if (btn?.dataset?.edit){
        e.stopPropagation();
        fillForm(h);
        return;
      }
      if (btn?.dataset?.del){
        e.stopPropagation();
        if (confirm(`削除しますか？\n${h.name}`)) deleteHospital(h.id);
        return;
      }
      map.panTo({lat: h.lat, lng: h.lng});
      map.setZoom(15);
      google.maps.event.trigger(mk, "click");
    });

    listEl.appendChild(div);
  });

  setStatus(`表示：${results.length}件（タグ ${need.size ? `AND ${[...need].join(" / ")}` : "指定なし"}）`);
}

function initMap(){
  geocoder = new google.maps.Geocoder();
  directions = new google.maps.DirectionsService();
  infoWindow = new google.maps.InfoWindow();

  map = new google.maps.Map($("map"), {
    center: {lat: 34.6937, lng: 135.5023},
    zoom: 12,
    mapTypeControl: false
  });

  renderTagBox("searchTags", []);
  renderTagBox("formTags", []);

  if (!$("origin").value) $("origin").value = "桜川駅";

  $("btnSearch").addEventListener("click", runSearch);
  $("btnSave").addEventListener("click", saveHospital);
  $("btnReset").addEventListener("click", resetForm);
  $("btnExport").addEventListener("click", exportHospitalsJSON);
  $("origin").addEventListener("keydown", (e)=>{ if(e.key==="Enter") runSearch(); });

  setStatus(`準備OK：データ ${hospitals.length}件`);
}
window.initMap = initMap;
</script>

<!-- ✅ places を入れてスマホで地名解決を安定、defer で初期化安定 -->
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBM8lxW4kmGpwxF-9Yp9rj8LMakrbBtfQE&callback=initMap&language=ja&region=JP&libraries=places">
</script>

</body>
</html>
