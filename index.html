<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>大阪市 病院検索</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
header{padding:12px;border-bottom:1px solid #ddd;background:#fafafa}
label{font-size:12px;color:#555;display:block;margin-bottom:4px}
input,button,textarea{padding:10px;font-size:15px;border:1px solid #ccc;border-radius:8px}
button{cursor:pointer;background:#fff}
textarea{min-height:80px}

.row{display:flex;gap:10px;flex-wrap:wrap}
.grow{flex:1 1 300px}
.right{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}

.small{font-size:12px;color:#666}
.warn{color:#b00;font-weight:600}

#wrap{
  display:grid;
  grid-template-columns:1fr;
  height:auto;
}

#map{width:100%;height:320px}

.panel{padding:12px;border-bottom:1px solid #eee}
.card{padding:10px;border-bottom:1px solid #eee}
.card:hover{background:#f7f7f7}

.badge{font-size:11px;padding:2px 6px;border:1px solid #ccc;border-radius:999px;margin-right:4px}

@media(min-width:900px){
  #wrap{
    grid-template-columns:1.2fr 1fr;
    height:calc(100vh - 180px);
  }
  #map{height:100%}
}
</style>
</head>

<body>

<header>
<div class="row">
<div class="grow">
<label>出発地</label>
<input id="origin" style="width:100%" value="桜川駅">
</div>

<div class="right">
<div>
<label>範囲(km)</label>
<input id="radiusKm" type="number" value="8" style="width:90px">
</div>
<div>
<label>件数</label>
<input id="limit" type="number" value="20" style="width:70px">
</div>
<button id="btnSearch">検索</button>
<button id="btnExport">JSON出力</button>
</div>
</div>
<div class="small" id="status"></div>
</header>

<div id="wrap">
<div id="map"></div>

<div>
<div class="panel">
<h3>検索結果</h3>
<div id="list"></div>
</div>

<div class="panel">
<h3>病院追加 / 編集</h3>

<input id="hName" placeholder="病院名" style="width:100%;margin-bottom:6px">
<input id="hAddr" placeholder="住所" style="width:100%;margin-bottom:6px">
<input id="hTel" placeholder="電話番号" style="width:100%;margin-bottom:6px">
<input id="hNearest" placeholder="最寄り駅" style="width:100%;margin-bottom:6px">

<textarea id="hNote" placeholder="メモ" style="width:100%;margin-bottom:6px"></textarea>

<div class="row">
<button id="btnSave">保存</button>
<button id="btnReset">クリア</button>
</div>

</div>
</div>
</div>

<script>
const DB_KEY="osaka_hospital_db_v3";
let hospitals = JSON.parse(localStorage.getItem(DB_KEY)||"[]");

let map, geocoder, directions;
let markers=[];

const $=id=>document.getElementById(id);

function saveDB(){
localStorage.setItem(DB_KEY,JSON.stringify(hospitals));
}

function setStatus(t,w=false){
$("status").innerHTML=w?`<span class="warn">${t}</span>`:t;
}

function clearMarkers(){
markers.forEach(m=>m.setMap(null));
markers=[];
}

function geocode(addr){
return new Promise((ok,ng)=>{
geocoder.geocode({address:addr,region:"JP"},(r,s)=>{
if(s==="OK"&&r[0]) ok(r[0].geometry.location);
else ng("住所エラー");
});
});
}

async function saveHospital(){
const name=$("hName").value.trim();
const addr=$("hAddr").value.trim();
if(!name||!addr) return setStatus("病院名と住所必須",true);

let ll;
try{ll=await geocode(addr);}catch(e){return setStatus(e,true);}

const obj={
id:Date.now(),
name,
address:addr,
tel:$("hTel").value.trim(),
nearest:$("hNearest").value.trim(),
note:$("hNote").value.trim(),
lat:ll.lat(),
lng:ll.lng()
};

hospitals.push(obj);
saveDB();
setStatus("保存完了");
$("hName").value="";
$("hAddr").value="";
$("hTel").value="";
$("hNearest").value="";
$("hNote").value="";
runSearch();
}

async function runSearch(){
clearMarkers();
const originTxt=$("origin").value.trim();
if(!originTxt) return;

let origin;
try{origin=await geocode(originTxt);}catch(e){return;}

map.setCenter(origin);
map.setZoom(13);

let results=[...hospitals];
results=results.slice(0,$("limit").value);

$("list").innerHTML="";
results.forEach((h,i)=>{
const mk=new google.maps.Marker({
map,
position:{lat:h.lat,lng:h.lng},
label:String(i+1)
});
markers.push(mk);

const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<b>${i+1}. ${h.name}</b><br>
<span class="small">${h.address}</span><br>
${h.tel?`☎ ${h.tel}<br>`:""}
${h.nearest?`最寄:${h.nearest}<br>`:""}
${h.note?`<span class="small">${h.note}</span>`:""}
`;
$("list").appendChild(div);
});
}

function exportJSON(){
const blob=new Blob([JSON.stringify(hospitals,null,2)],{type:"application/json"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download="hospitals.json";
a.click();
URL.revokeObjectURL(url);
}

function initMap(){
geocoder=new google.maps.Geocoder();
directions=new google.maps.DirectionsService();
map=new google.maps.Map($("map"),{
center:{lat:34.6937,lng:135.5023},
zoom:12
});

$("btnSearch").addEventListener("click",runSearch);
$("btnSave").addEventListener("click",saveHospital);
$("btnReset").addEventListener("click",()=>location.reload());
$("btnExport").addEventListener("click",exportJSON);

runSearch();
}
window.initMap=initMap;
</script>

<script async
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBM8lxW4kmGpwxF-9Yp9rj8LMakrbBtfQE&callback=initMap&language=ja&region=JP">
</script>

</body>
</html>
